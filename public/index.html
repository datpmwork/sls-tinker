<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Act Log Viewer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            background: #1a1a1a;
            color: #e0e0e0;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: #2d2d2d;
            padding: 1rem;
            border-bottom: 1px solid #444;
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .header h1 {
            color: #4CAF50;
            font-size: 1.5rem;
        }

        .controls {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background-color 0.2s;
        }

        .btn-primary {
            background: #4CAF50;
            color: white;
        }

        .btn-primary:hover {
            background: #45a049;
        }

        .btn-secondary {
            background: #666;
            color: white;
        }

        .btn-secondary:hover {
            background: #555;
        }

        .btn-danger {
            background: #f44336;
            color: white;
        }

        .btn-danger:hover {
            background: #da190b;
        }

        .input {
            padding: 0.5rem;
            border: 1px solid #555;
            border-radius: 4px;
            background: #333;
            color: white;
            min-width: 200px;
        }

        .status {
            margin-left: auto;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .status.connected {
            background: #4CAF50;
            color: white;
        }

        .status.disconnected {
            background: #f44336;
            color: white;
        }

        .main {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        .sidebar {
            width: 250px;
            background: #2d2d2d;
            border-right: 1px solid #444;
            padding: 1rem;
            overflow-y: auto;
        }

        .filter-section {
            margin-bottom: 1rem;
        }

        .filter-section h3 {
            color: #4CAF50;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .filter-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.25rem;
            font-size: 0.8rem;
        }

        .filter-item input[type="checkbox"] {
            accent-color: #4CAF50;
        }

        .job-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .job-item {
            padding: 0.25rem 0;
            cursor: pointer;
            border-radius: 2px;
            transition: background-color 0.2s;
        }

        .job-item:hover {
            background: #444;
        }

        .job-item.selected {
            background: #4CAF50;
            color: white;
        }

        .log-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .log-header {
            background: #333;
            padding: 0.5rem 1rem;
            border-bottom: 1px solid #444;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .log-count {
            font-size: 0.9rem;
            color: #ccc;
        }

        .logs {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .log-entry {
            margin-bottom: 0.5rem;
            padding: 0.5rem;
            border-radius: 4px;
            border-left: 4px solid;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-10px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .log-entry.info {
            border-left-color: #2196F3;
            background: rgba(33, 150, 243, 0.1);
        }

        .log-entry.success {
            border-left-color: #4CAF50;
            background: rgba(76, 175, 80, 0.1);
        }

        .log-entry.warning {
            border-left-color: #FF9800;
            background: rgba(255, 152, 0, 0.1);
        }

        .log-entry.error {
            border-left-color: #f44336;
            background: rgba(244, 67, 54, 0.1);
        }

        .log-meta {
            display: flex;
            gap: 1rem;
            font-size: 0.8rem;
            color: #999;
            margin-bottom: 0.25rem;
        }

        .log-job {
            color: #4CAF50;
            font-weight: bold;
        }

        .log-message {
            color: #e0e0e0;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .stats {
            display: flex;
            gap: 1rem;
            font-size: 0.8rem;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .stat-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .stat-dot.info { background: #2196F3; }
        .stat-dot.success { background: #4CAF50; }
        .stat-dot.warning { background: #FF9800; }
        .stat-dot.error { background: #f44336; }

        .logdy-notice {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            padding: 1rem;
            text-align: center;
            border-bottom: 1px solid #444;
        }

        .notice-content h3 {
            margin-bottom: 0.5rem;
            font-size: 1.2rem;
        }

        .notice-content p {
            margin-bottom: 1rem;
            opacity: 0.9;
        }

        .logdy-notice .btn {
            margin: 0 0.5rem;
        }
    </style>
</head>
<body>
<div class="header">
    <h1>Act Log Viewer</h1>
    <div class="controls">
        <input type="text" id="actArgs" class="input" placeholder="Act arguments (e.g., --verbose)" />
        <label>
            <input type="checkbox" id="useLogdy" checked /> Use Logdy UI
        </label>
        <button class="btn btn-primary" onclick="startAct()">Start Act</button>
        <button class="btn btn-secondary" onclick="startLogdy()">Start Logdy</button>
        <button class="btn btn-danger" onclick="stopProcesses()">Stop All</button>
        <button class="btn btn-secondary" onclick="clearLogs()">Clear Logs</button>
        <button class="btn btn-secondary" onclick="toggleAutoScroll()">Auto-scroll: <span id="autoScrollStatus">ON</span></button>
    </div>
    <div class="status" id="connectionStatus">Disconnected</div>
    <div class="status" id="logdyStatus">Logdy: Unknown</div>
</div>

<div class="main">
    <div class="logdy-notice" id="logdyNotice" style="display: none;">
        <div class="notice-content">
            <h3>ðŸš€ Logdy UI Active</h3>
            <p>Act logs are being streamed to Logdy for a better viewing experience!</p>
            <a href="#" id="logdyLink" target="_blank" class="btn btn-primary">Open Logdy UI</a>
            <button class="btn btn-secondary" onclick="hideLogdyNotice()">Hide</button>
        </div>
    </div>
    <div class="sidebar">
        <div class="filter-section">
            <h3>Log Types</h3>
            <div class="filter-item">
                <input type="checkbox" id="filter-info" checked onchange="updateFilters()">
                <label for="filter-info">Info</label>
            </div>
            <div class="filter-item">
                <input type="checkbox" id="filter-success" checked onchange="updateFilters()">
                <label for="filter-success">Success</label>
            </div>
            <div class="filter-item">
                <input type="checkbox" id="filter-warning" checked onchange="updateFilters()">
                <label for="filter-warning">Warning</label>
            </div>
            <div class="filter-item">
                <input type="checkbox" id="filter-error" checked onchange="updateFilters()">
                <label for="filter-error">Error</label>
            </div>
        </div>

        <div class="filter-section">
            <h3>Jobs</h3>
            <div class="job-list" id="jobList">
                <div class="job-item selected" data-job="all">All Jobs</div>
            </div>
        </div>

        <div class="filter-section">
            <h3>Statistics</h3>
            <div class="stats" id="stats">
                <div class="stat-item">
                    <div class="stat-dot info"></div>
                    <span id="stat-info">0</span>
                </div>
                <div class="stat-item">
                    <div class="stat-dot success"></div>
                    <span id="stat-success">0</span>
                </div>
                <div class="stat-item">
                    <div class="stat-dot warning"></div>
                    <span id="stat-warning">0</span>
                </div>
                <div class="stat-item">
                    <div class="stat-dot error"></div>
                    <span id="stat-error">0</span>
                </div>
            </div>
        </div>
    </div>

    <div class="log-container">
        <div class="log-header">
            <div class="log-count">Logs: <span id="logCount">0</span></div>
            <div class="log-count">Filtered: <span id="filteredCount">0</span></div>
        </div>
        <div class="logs" id="logs"></div>
    </div>
</div>

<script>
    let ws = null;
    let logs = [];
    let filteredLogs = [];
    let jobs = new Set(['all']);
    let selectedJob = 'all';
    let autoScroll = true;
    let stats = { info: 0, success: 0, warning: 0, error: 0 };
    let logdyAvailable = false;
    let logdyUrl = null;

    // WebSocket connection
    function connectWebSocket() {
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        ws = new WebSocket(`${protocol}//${window.location.host}`);

        ws.onopen = function() {
            document.getElementById('connectionStatus').textContent = 'Connected';
            document.getElementById('connectionStatus').className = 'status connected';
        };

        ws.onmessage = function(event) {
            const logData = JSON.parse(event.data);

            if (logData.type === 'logdy_status') {
                logdyAvailable = logData.available;
                logdyUrl = logData.available ? `http://localhost:${logData.port}` : null;
                updateLogdyStatus();
                return;
            }

            if (logData.raw === 'LOGS_CLEARED') {
                logs = [];
                stats = { info: 0, success: 0, warning: 0, error: 0 };
                jobs.clear();
                jobs.add('all');
                selectedJob = 'all';
                updateDisplay();
                return;
            }

            logs.push(logData);

            // Update stats
            stats[logData.type] = (stats[logData.type] || 0) + 1;

            // Update jobs list
            if (logData.job) {
                jobs.add(logData.job);
            }

            updateDisplay();
        };

        ws.onclose = function() {
            document.getElementById('connectionStatus').textContent = 'Disconnected';
            document.getElementById('connectionStatus').className = 'status disconnected';
            // Attempt to reconnect after 3 seconds
            setTimeout(connectWebSocket, 3000);
        };

        ws.onerror = function(error) {
            console.error('WebSocket error:', error);
        };
    }

    function updateDisplay() {
        updateFilters();
        updateJobsList();
        updateStats();
        updateLogCount();
    }

    function updateFilters() {
        const filters = {
            info: document.getElementById('filter-info').checked,
            success: document.getElementById('filter-success').checked,
            warning: document.getElementById('filter-warning').checked,
            error: document.getElementById('filter-error').checked
        };

        filteredLogs = logs.filter(log => {
            const typeMatch = filters[log.type];
            const jobMatch = selectedJob === 'all' || log.job === selectedJob;
            return typeMatch && jobMatch;
        });

        renderLogs();
    }

    function updateJobsList() {
        const jobList = document.getElementById('jobList');
        jobList.innerHTML = '';

        jobs.forEach(job => {
            const jobItem = document.createElement('div');
            jobItem.className = `job-item ${job === selectedJob ? 'selected' : ''}`;
            jobItem.dataset.job = job;
            jobItem.textContent = job === 'all' ? 'All Jobs' : job;
            jobItem.onclick = () => selectJob(job);
            jobList.appendChild(jobItem);
        });
    }

    function selectJob(job) {
        selectedJob = job;
        updateDisplay();
    }

    function updateStats() {
        document.getElementById('stat-info').textContent = stats.info || 0;
        document.getElementById('stat-success').textContent = stats.success || 0;
        document.getElementById('stat-warning').textContent = stats.warning || 0;
        document.getElementById('stat-error').textContent = stats.error || 0;
    }

    function updateLogCount() {
        document.getElementById('logCount').textContent = logs.length;
        document.getElementById('filteredCount').textContent = filteredLogs.length;
    }

    function renderLogs() {
        const logsContainer = document.getElementById('logs');
        logsContainer.innerHTML = '';

        filteredLogs.forEach(log => {
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${log.type}`;

            const timestamp = new Date(log.timestamp).toLocaleTimeString();

            logEntry.innerHTML = `
                    <div class="log-meta">
                        <span>${timestamp}</span>
                        ${log.job ? `<span class="log-job">[${log.job}]</span>` : ''}
                        <span class="log-type">${log.type.toUpperCase()}</span>
                    </div>
                    <div class="log-message">${escapeHtml(log.message)}</div>
                `;

            logsContainer.appendChild(logEntry);
        });

        if (autoScroll) {
            logsContainer.scrollTop = logsContainer.scrollHeight;
        }
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function updateLogdyStatus() {
        const statusEl = document.getElementById('logdyStatus');
        if (logdyAvailable) {
            statusEl.textContent = 'Logdy: Ready';
            statusEl.className = 'status connected';
        } else {
            statusEl.textContent = 'Logdy: Not Available';
            statusEl.className = 'status disconnected';
        }
    }

    function showLogdyNotice(url) {
        const notice = document.getElementById('logdyNotice');
        const link = document.getElementById('logdyLink');
        link.href = url;
        notice.style.display = 'block';
    }

    function hideLogdyNotice() {
        document.getElementById('logdyNotice').style.display = 'none';
    }

    function startAct() {
        const args = document.getElementById('actArgs').value;
        const useLogdy = document.getElementById('useLogdy').checked;

        const params = new URLSearchParams();
        if (args) params.append('args', args);
        if (useLogdy) params.append('logdy', 'true');

        fetch(`/api/start-act?${params.toString()}`)
            .then(response => response.json())
            .then(data => {
                console.log('Act started:', data);
                if (data.useLogdy && data.logdyUrl) {
                    showLogdyNotice(data.logdyUrl);
                }
            })
            .catch(error => {
                console.error('Error starting act:', error);
            });
    }

    function startLogdy() {
        fetch('/api/start-logdy')
            .then(response => response.json())
            .then(data => {
                console.log('Logdy start result:', data);
                if (data.success) {
                    logdyAvailable = true;
                    logdyUrl = data.url;
                    updateLogdyStatus();
                    // Open logdy in new tab
                    window.open(data.url, '_blank');
                } else {
                    alert('Failed to start Logdy. Make sure it is installed.');
                }
            })
            .catch(error => {
                console.error('Error starting logdy:', error);
            });
    }

    function stopProcesses() {
        fetch('/api/stop-processes')
            .then(response => response.json())
            .then(data => {
                console.log('Processes stopped:', data);
                hideLogdyNotice();
                logdyAvailable = false;
                logdyUrl = null;
                updateLogdyStatus();
            })
            .catch(error => {
                console.error('Error stopping processes:', error);
            });
    }

    function clearLogs() {
        fetch('/api/clear-logs')
            .then(response => response.json())
            .then(data => {
                console.log('Logs cleared:', data);
            })
            .catch(error => {
                console.error('Error clearing logs:', error);
            });
    }

    function toggleAutoScroll() {
        autoScroll = !autoScroll;
        document.getElementById('autoScrollStatus').textContent = autoScroll ? 'ON' : 'OFF';
    }

    // Initialize
    connectWebSocket();

    // Check logdy status on load
    fetch('/api/logdy-status')
        .then(response => response.json())
        .then(data => {
            logdyAvailable = data.available;
            logdyUrl = data.url;
            updateLogdyStatus();
        })
        .catch(error => {
            console.error('Error checking logdy status:', error);
        });
</script>
</body>
</html>
